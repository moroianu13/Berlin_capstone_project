<!DOCTYPE html>
<html lang="en">
<head>
    {% load static %}
    <meta charset="utf-8">
    <title>{{ borough.name }} Neighborhoods</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.css" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/styles.css' %}">
</head>
<body>
    <header>
        <div class="logo">
            <img src="{% static 'images/rentwise_logo.png' %}" alt="RentWise Berlin Logo">
        </div>
        <nav>
            <ul>
                <li>
                    <a href="{% url 'home' %}" class="header-button">Home</a>
                    <a href="{% url 'borough_list' %}" class="header-button">Boroughs</a>
                </li>
            </ul>
        </nav>
    </header>

    <div class="container">
        <div id="neighborhood-list">
            <h2>{{ borough.name }} Neighborhoods</h2>
            <ul id="neighborhood-items">
                {% for neighborhood in neighborhoods %}
                    <li data-neighborhood="{{ neighborhood.name }}">
                        <a href="{% url 'neighborhood_detail' neighborhood.id %}">{{ neighborhood.name }}</a>
                    </li>
                {% endfor %}
            </ul>
        </div>

        <div id="map"></div>
    </div>

    <footer>
        <p>Â© 2024 RentWise Berlin. All rights reserved.</p>
    </footer>

    <!-- Include Mapbox GL JS -->
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Turf.js/6.5.0/turf.min.js"></script>
    <script type="text/javascript">
        const boroughSlug = "{{ borough.slug }}";  // Pass the slug to JavaScript
    </script>
    <script>
        mapboxgl.accessToken = 'pk.eyJ1IjoibW9yb3dpbmQiLCJhIjoiY20xN3NoODc2MHEwaDJxcXhnZjBqOHZreiJ9.hE85kqOC-_iHDHTlwcMf-A';

        // Initialize the map
        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/streets-v11',
            center: [13.4, 52.52],  // Center on Berlin
            zoom: 12
        });

        map.on('load', function() {
            fetch(`/neighborhood_data_api/${encodeURIComponent(boroughSlug)}/`)
                .then(response => response.json())
                .then(geojsonData => {
                    if (geojsonData.error) {
                        console.error(geojsonData.error);
                        return;
                    }

                    map.addSource('neighborhoods', {
                        'type': 'geojson',
                        'data': geojsonData
                    });

                    map.addLayer({
                        'id': 'neighborhoods-layer',
                        'type': 'fill',
                        'source': 'neighborhoods',
                        'paint': {
                            'fill-color': '#888888',
                            'fill-opacity': 0.5,
                            'fill-outline-color': '#000000'
                        }
                    });

                    const center = turf.centroid(geojsonData).geometry.coordinates;
                    map.flyTo({
                        center: center,
                        zoom: 10.5
                    });

                    document.querySelectorAll('#neighborhood-items li').forEach(item => {
                        item.addEventListener('mouseover', function() {
                            const neighborhoodName = this.dataset.neighborhood;
                            map.setPaintProperty('neighborhoods-layer', 'fill-color', [
                                'case',
                                ['==', ['get', 'name'], neighborhoodName], '#00FF00',
                                '#888888'
                            ]);
                        });

                        item.addEventListener('mouseout', function() {
                            map.setPaintProperty('neighborhoods-layer', 'fill-color', [
                                'case',
                                ['boolean', ['feature-state', 'hover'], false], '#888888',
                                '#888888'
                            ]);
                        });
                    });
                })
                .catch(error => console.error('Error fetching neighborhood data:', error));
        });
    </script>
</body>
</html>
