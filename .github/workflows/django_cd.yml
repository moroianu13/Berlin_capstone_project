name: Django CI/CD

on:
  push:
    branches: [ "main" ]  # Trigger for pushes to main
  pull_request:
    branches: [ "main" ]  # Trigger for pull requests to main
  workflow_dispatch:       # Allow manual trigger of the workflow

jobs:

  # CD: Deploy Job
  deploy:
    #needs: build  # Runs after the 'build' job
    runs-on: ubuntu-latest

    steps:
    - name: Check out code
      uses: actions/checkout@v4

    - name: Deploy to EC2 with Docker Compose
      env:
        DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}  # Add EC2 public IP in GitHub Secrets
        DEPLOY_USER: ${{ secrets.DEPLOY_USER }}  # Add EC2 SSH username (e.g., ubuntu for AWS AMI)
        PEM_FILE: ${{ secrets.EC2_PEM_FILE }}    # Add PEM file content in GitHub Secrets
      run: |
        # Add the .pem file to a temporary location and set permissions
        echo "$PEM_FILE" > ec2_key.pem
        chmod 600 ec2_key.pem

        # Connect to EC2 and deploy using Docker Compose
        ssh -i ec2_key.pem -o IdentitiesOnly=yes $DEPLOY_USER@$DEPLOY_HOST "
          cd /home/ubuntu/backend &&
          git pull origin main &&
          docker compose down &&
          docker compose build &&
          docker compose up -d
        "

# Clean up the PEM file after use
        rm -f ec2_key.pem
