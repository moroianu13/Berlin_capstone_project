 - name: Deploy to EC2 with Docker Compose
   env:
     DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
     DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
     PEM_FILE: ${{ secrets.EC2_PEM_FILE }}
   run: |
      # Write the PEM file to a temporary location
      printf "%s" "$PEM_FILE" > ec2_key.pem

      # Set the correct file permissions
      chmod 600 ec2_key.pem

      # Add the EC2 host key to known_hosts
      ssh-keyscan -H $DEPLOY_HOST >> ~/.ssh/known_hosts

      # Connect to EC2 and deploy using Docker Compose
      ssh -i ec2_key.pem -o IdentitiesOnly=yes $DEPLOY_USER@$DEPLOY_HOST "
        set -e  # Stop on errors
        cd /home/ubuntu/backend &&
        git pull origin main &&
        docker compose down &&
        docker compose build &&
        docker compose up -d
    "

    # Clean up the PEM file
    rm -f ec2_key.pem
